# üß™ Discord Bot MGM - Suite de Tests Moderne

**Suite de tests compl√®te et professionnelle pour le Discord Bot MGM avec coverage automatique et architecture moderne.**

## üìã Table des Mati√®res

- [üöÄ D√©marrage Rapide](#-d√©marrage-rapide)
- [üèóÔ∏è Architecture des Tests](#Ô∏è-architecture-des-tests)
- [üîß Installation](#-installation) 
- [üíª Utilisation](#-utilisation)
- [üìä Coverage et Rapports](#-coverage-et-rapports)
- [üéØ Types de Tests](#-types-de-tests)
- [üìù √âcrire de Nouveaux Tests](#-√©crire-de-nouveaux-tests)
- [üîç D√©pannage](#-d√©pannage)
- [‚öôÔ∏è Configuration Avanc√©e](#Ô∏è-configuration-avanc√©e)

## üöÄ D√©marrage Rapide

### Installation des D√©pendances
```bash
pip install -r tests/requirements_test.txt
```

### Ex√©cuter Tous les Tests avec Coverage
```bash
python tests/test_runner.py
```

### Ouvrir le Rapport HTML
```bash
python tests/test_runner.py --html
```

## üèóÔ∏è Architecture des Tests

```
tests/
‚îú‚îÄ‚îÄ üìÅ core/                        # Tests des modules core/
‚îÇ   ‚îú‚îÄ‚îÄ test_translation.py         # Syst√®me de traduction
‚îÇ   ‚îú‚îÄ‚îÄ test_functions.py           # Fonctions utilitaires
‚îÇ   ‚îú‚îÄ‚îÄ test_rate_limiter.py        # Rate limiting
‚îÇ   ‚îî‚îÄ‚îÄ test_*.py                   # Autres modules core
‚îú‚îÄ‚îÄ üìÅ cogs/                        # Tests des cogs Discord
‚îÇ   ‚îú‚îÄ‚îÄ test_absence.py             # Gestion des absences  
‚îÇ   ‚îú‚îÄ‚îÄ test_guild_members.py       # Gestion des membres
‚îÇ   ‚îú‚îÄ‚îÄ test_guild_events.py        # √âv√©nements de guilde
‚îÇ   ‚îî‚îÄ‚îÄ test_*.py                   # Autres cogs
‚îú‚îÄ‚îÄ üìÅ integration/                 # Tests d'int√©gration
‚îÇ   ‚îú‚îÄ‚îÄ test_translation_integration.py  # Int√©gration traduction
‚îÇ   ‚îú‚îÄ‚îÄ test_bot_startup.py         # D√©marrage du bot
‚îÇ   ‚îî‚îÄ‚îÄ test_*.py                   # Autres int√©grations
‚îú‚îÄ‚îÄ üìÅ utils/                       # Tests utilitaires
‚îÇ   ‚îú‚îÄ‚îÄ test_config.py              # Configuration
‚îÇ   ‚îî‚îÄ‚îÄ test_*.py                   # Autres utilitaires
‚îú‚îÄ‚îÄ üîß conftest.py                  # Configuration pytest globale
‚îú‚îÄ‚îÄ üöÄ test_runner.py               # Point d'entr√©e unique
‚îú‚îÄ‚îÄ üìã requirements_test.txt        # D√©pendances tests
‚îú‚îÄ‚îÄ ‚öôÔ∏è pyproject.toml               # Configuration moderne
‚îú‚îÄ‚îÄ üìä .coveragerc                  # Configuration coverage
‚îî‚îÄ‚îÄ üìö README_TESTS.md              # Cette documentation
```

## üîß Installation

### 1. Pr√©requis
- Python 3.9+
- Acc√®s au projet Discord Bot MGM
- D√©pendances du bot install√©es

### 2. Installation des D√©pendances de Test
```bash
# Installation des d√©pendances de test
pip install -r tests/requirements_test.txt

# V√©rification de l'installation
python tests/test_runner.py --help
```

### 3. V√©rification de l'Environnement
```bash
# Test rapide de validation
python tests/test_runner.py --fast
```

## üíª Utilisation

### Commands Principales

```bash
# üî• EX√âCUTION COMPL√àTE
python tests/test_runner.py                    # Tous les tests + coverage

# üéØ TESTS SP√âCIFIQUES
python tests/test_runner.py --unit             # Tests unitaires seulement
python tests/test_runner.py --integration      # Tests d'int√©gration seulement
python tests/test_runner.py --core             # Modules core/ seulement
python tests/test_runner.py --cog absence      # Cog sp√©cifique

# ‚ö° TESTS RAPIDES
python tests/test_runner.py --fast             # Tests rapides (sans marker slow)
python tests/test_runner.py --unit --fast      # Tests unitaires rapides

# üìä COVERAGE
python tests/test_runner.py --no-coverage      # Sans rapport coverage
python tests/test_runner.py --coverage-only    # G√©n√©rer rapport seulement
python tests/test_runner.py --html             # Ouvrir rapport HTML

# üîç MODES DE SORTIE
python tests/test_runner.py --quiet            # Mode silencieux
python tests/test_runner.py --debug            # Mode debug d√©taill√©
```

### Exemples d'Usage Courants

```bash
# D√©veloppement quotidien - tests rapides
python tests/test_runner.py --unit --fast

# Avant commit - suite compl√®te
python tests/test_runner.py

# Debug d'un probl√®me sp√©cifique
python tests/test_runner.py --cog guild_members --debug

# V√©rifier la couverture d'un module
python tests/test_runner.py --core --html

# Tests d'int√©gration avant d√©ploiement
python tests/test_runner.py --integration
```

## üìä Coverage et Rapports

### Types de Rapports G√©n√©r√©s

1. **Rapport Terminal** - R√©sum√© dans la console
2. **Rapport HTML** - D√©taill√© avec navigation (`htmlcov/index.html`)
3. **Rapport XML** - Pour outils CI/CD (`coverage.xml`)

### M√©triques de Coverage

- **Objectif Global**: >80% de couverture
- **Modules Core**: >90% de couverture
- **Cogs Principaux**: >75% de couverture
- **Tests d'Int√©gration**: >70% de couverture

### Interpr√©tation des Rapports

```bash
# G√©n√©ration et ouverture du rapport HTML
python tests/test_runner.py --html

# Structure du rapport:
htmlcov/
‚îú‚îÄ‚îÄ index.html          # Page principale avec r√©sum√©
‚îú‚îÄ‚îÄ app_*.html          # Coverage par fichier
‚îî‚îÄ‚îÄ status.json         # Donn√©es JSON pour outils
```

## üéØ Types de Tests

### 1. Tests Unitaires (`tests/core/`, `tests/cogs/`)
- **Objectif**: Tester des fonctions/m√©thodes isol√©es
- **Marqueurs**: `@pytest.mark.unit`, `@pytest.mark.core`, `@pytest.mark.cog`
- **Exemple**:
```python
@pytest.mark.unit
@pytest.mark.core
def test_sanitize_kwargs():
    from core.functions import sanitize_kwargs
    result = sanitize_kwargs(username="test", level=42)
    assert result == {"username": "test", "level": "42"}
```

### 2. Tests d'Int√©gration (`tests/integration/`)
- **Objectif**: Tester l'interaction entre composants
- **Marqueurs**: `@pytest.mark.integration`
- **Exemple**:
```python
@pytest.mark.integration
@pytest.mark.asyncio
async def test_translation_with_cache():
    # Test int√©gration syst√®me traduction + cache
    pass
```

### 3. Tests de Performance (`@pytest.mark.slow`)
- **Objectif**: Tester les performances sous charge
- **Marqueurs**: `@pytest.mark.slow`, `@pytest.mark.performance`

### 4. Tests de Robustesse
- **Objectif**: Tester la gestion d'erreurs et cas limites
- **Marqueurs**: `@pytest.mark.reliability`

## üìù √âcrire de Nouveaux Tests

### Structure Type d'un Test

```python
"""
Tests pour [module] - [Description courte].
"""

import pytest
from unittest.mock import Mock, AsyncMock
from pathlib import Path
import sys

# Configuration du chemin
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

@pytest.mark.[category]  # unit, integration, cog, core
@pytest.mark.asyncio    # Si fonctions async
class Test[ComponentName]:
    """Test [Component] functionality."""
    
    @pytest.fixture
    def mock_component(self):
        """Create mock component for testing."""
        return Mock()
    
    async def test_[specific_functionality](self, mock_component):
        """Test [specific functionality] with clear description."""
        # Arrange
        expected_result = "expected"
        
        # Act
        result = await component_function(mock_component)
        
        # Assert
        assert result == expected_result
```

### Bonnes Pratiques

1. **Noms de Tests Descriptifs**
   ```python
   def test_gs_command_with_valid_value()    # ‚úÖ Bon
   def test_gs()                             # ‚ùå Mauvais
   ```

2. **Utilisation des Fixtures**
   ```python
   @pytest.fixture
   def mock_bot(self):
       bot = Mock()
       bot.cache = Mock()
       return bot
   ```

3. **Marqueurs Appropri√©s**
   ```python
   @pytest.mark.unit      # Test unitaire
   @pytest.mark.cog       # Test de cog
   @pytest.mark.slow      # Test lent (>1s)
   @pytest.mark.asyncio   # Test asynchrone
   ```

4. **Assertions Claires**
   ```python
   assert result.status == "success"
   assert len(results) == 3
   assert "error" not in response.content
   ```

### Ajouter un Nouveau Cog

1. **Cr√©er le fichier de test**:
   ```bash
   touch tests/cogs/test_[nom_du_cog].py
   ```

2. **Structure de base**:
   ```python
   @pytest.mark.cog
   @pytest.mark.asyncio
   class Test[NomDuCog]:
       @pytest.fixture
       def [nom_du_cog]_cog(self, mock_bot):
           from app.cogs.[nom_du_cog] import [NomDuCog]
           return [NomDuCog](mock_bot)
   ```

3. **Ajouter les tests de commandes**:
   ```python
   async def test_[commande]_success(self, [nom_du_cog]_cog, mock_ctx):
       await [nom_du_cog]_cog.[commande](mock_ctx, "param")
       mock_ctx.respond.assert_called_once()
   ```

## üîç D√©pannage

### Probl√®mes Courants

#### 1. **Erreurs d'Import**
```bash
# Sympt√¥me
ImportError: No module named 'app'

# Solution
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
python tests/test_runner.py
```

#### 2. **Tests qui √âchouent de Fa√ßon Intermittente**
```bash
# Analyser les tests avec plus de verbosit√©
python tests/test_runner.py --debug

# Isoler un test sp√©cifique
python -m pytest tests/core/test_translation.py::TestTranslationLoading::test_load_translations_success -v
```

#### 3. **Probl√®mes de Coverage**
```bash
# V√©rifier la configuration coverage
cat tests/.coveragerc

# R√©g√©n√©rer compl√®tement le coverage
rm -rf htmlcov coverage.xml
python tests/test_runner.py
```

#### 4. **Tests Lents**
```bash
# Identifier les tests lents
python tests/test_runner.py --debug | grep "slow"

# Ex√©cuter sans les tests lents
python tests/test_runner.py --fast
```

### Debugging Avanc√©

```bash
# Mode debug complet avec traces
python -m pytest tests/ -v -s --tb=long

# Tests avec profiling
python -m pytest tests/ --profile-svg

# Tests avec coverage d√©taill√© par branche
python tests/test_runner.py --debug
```

## ‚öôÔ∏è Configuration Avanc√©e

### Variables d'Environnement

```bash
# Configuration pour les tests
export ENVIRONMENT=test
export LOG_LEVEL=DEBUG
export DATABASE_URL=sqlite:///:memory:
export DISCORD_TOKEN=test_token_for_testing
```

### Configuration pytest Personnalis√©e

Modifier `tests/pyproject.toml`:

```toml
[tool.pytest.ini_options]
# Ajouter des marqueurs personnalis√©s
markers = [
    "slow: Tests lents (>1s)",
    "database: Tests n√©cessitant une DB",
    "custom: Tests personnalis√©s"
]

# Modifier la couverture cible
fail_under = 85
```

### Hooks Personnalis√©s

Ajouter dans `tests/conftest.py`:

```python
def pytest_configure(config):
    """Configuration personnalis√©e pytest."""
    config.addinivalue_line("markers", "custom: Description du marqueur")

def pytest_runtest_setup(item):
    """Ex√©cut√© avant chaque test."""
    pass
```

### Int√©gration CI/CD

#### GitHub Actions
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install dependencies
        run: pip install -r tests/requirements_test.txt
      - name: Run tests with coverage
        run: python tests/test_runner.py
      - name: Upload coverage
        uses: codecov/codecov-action@v1
        with:
          file: coverage.xml
```

### Optimisation des Performances

1. **Tests Parall√®les**:
   ```bash
   pip install pytest-xdist
   python -m pytest tests/ -n auto
   ```

2. **Cache des D√©pendances**:
   ```python
   # Dans conftest.py
   @pytest.fixture(scope="session")
   def cached_translations():
       # Cache global pour les traductions
   ```

3. **Mock Optimis√©**:
   ```python
   # Utiliser des mocks r√©utilisables
   @pytest.fixture(scope="session")
   def global_mock_bot():
       return create_extensive_bot_mock()
   ```

---

## üìö Ressources Suppl√©mentaires

- **Documentation Pytest**: https://docs.pytest.org/
- **Coverage.py**: https://coverage.readthedocs.io/
- **Discord.py Testing**: https://discordpy.readthedocs.io/en/stable/testing.html

## ü§ù Contribution

1. **Ajout de Tests**: Suivre les conventions d√©crites dans ce guide
2. **Modification des Tests**: Maintenir la couverture >80%
3. **Nouveaux Marqueurs**: Documenter dans `pyproject.toml`
4. **Performance**: Marquer les tests lents avec `@pytest.mark.slow`

---

**üìû Support**: En cas de probl√®me, v√©rifier d'abord la section [D√©pannage](#-d√©pannage) ou analyser les logs avec `--debug`.

**‚ö° Conseil**: Utilisez `python tests/test_runner.py --fast` pour les d√©veloppements rapides et la suite compl√®te avant les commits importants.